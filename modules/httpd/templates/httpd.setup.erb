#!/bin/bash

initvar(){
  # adss system infomation
  adss_basepath=<%= scope.lookupvar('baseconf::globalparams::basepath') %>
  adss_statusfile=<%= scope.lookupvar('baseconf::globalparams::statusfile') %>

  # OS information
  processorcount="<%= @processorcount %>"
  profile="/etc/profile"

  # install system infomation
  prog="httpd"

  pkg="<%= scope.lookupvar('httpd::pkg') %>"

  prefix="<%= scope.lookupvar('httpd::prefix_dir') %>"
  conf_dir="<%= scope.lookupvar('httpd::conf_dir') %>"
  confd_dir="<%= scope.lookupvar('httpd::confd_dir') %>"

  compile_opt="<%= scope.lookupvar('httpd::compile_opt') %>"

  nowversion="$(cat ${prefix}/${adss_statusfile} | grep "version" | sed "s/.*=//g")"
  orderversion="<%= scope.lookupvar('httpd::version') %>"
}

compile(){
  tar xvf ${adss_basepath}/${prog}/${pkg} -C ${adss_basepath}/${prog}
  cd ${adss_basepath}/${prog}/${pkg%.*.*}
  ./configure --prefix=${prefix} --sysconfdir=${conf_dir} ${compile_opt}
  make -j <%= @processorcount %> && make install
  rm -rf ${adss_basepath}/${prog}/${pkg%.*.*}
}

post(){
  mkdir -pv ${confd_dir}

  chmod 755 ${confd_dir}
}

regpath(){
  # path register
  if [ $(cat ${profile} | grep httpd | wc -l) -eq 0 ]; then
    echo "export PATH=\$PATH:${prefix}/bin" >> ${profile}
  fi
}

adsstag(){
  echo "version=${orderversion}" > ${prefix}/${adss_statusfile}
}

# main process
install(){
  compile
  post
  regpath
  adsstag
  return 0
}

uninstall(){
  service ${prog} stop
  [ -f "${prefix}/${adss_statusfile}" ] && rm -f ${prefix}/${adss_statusfile}
  [ -d ${prefix} ] && rm -rf ${prefix}

  # path unregister
  sed -i "/httpd/d" ${profile}
}

initvar
if [ "${nowversion}" != "${orderversion}" ]; then
  uninstall
  install
fi


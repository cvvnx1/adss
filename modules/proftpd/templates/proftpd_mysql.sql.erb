<% if @mysqlhost %>
CREATE DATABASE IF NOT EXISTS <%= @mysqldb %>;

GRANT all privileges
 ON <%= @mysqldb %>.* TO
 '<%= @mysqlacc %>'@'%' IDENTIFIED BY '<%= @mysqlpsw %>';
FLUSH PRIVILEGES;

USE <%= @mysqldb %>;

CREATE TABLE IF NOT EXISTS <%= @mysqldb %>.users (
  userid VARCHAR(30) NOT NULL UNIQUE,
  passwd VARCHAR(80) NOT NULL DEFAULT '',
  uid INTEGER UNIQUE NOT NULL UNIQUE,
  gid INTEGER NOT NULL DEFAULT 0,
  homedir VARCHAR(255) NOT NULL DEFAULT '',
  shell VARCHAR(255) NOT NULL DEFAULT '',
  last_accessed DATETIME NOT NULL,
  login_count INTEGER NOT NULL DEFAULT 0
);
CREATE INDEX users_userid_idx ON <%= @mysqldb %>.users (userid);

LOCK TABLES <%= @mysqldb %>.users WRITE;
INSERT INTO <%= @mysqldb %>.users
 (userid,passwd,uid,gid,homedir,shell,login_count)
VALUES
 ('user','user',2002,2002,'/opt/ftp/user','/sbin/nologin',0);
UNLOCK TABLES;

CREATE TABLE IF NOT EXISTS <%= @mysqldb %>.groups (
  groupname VARCHAR(30) NOT NULL,
  gid INTEGER NOT NULL UNIQUE,
  members VARCHAR(255)
);
CREATE INDEX groups_gid_idx ON <%= @mysqldb %>.groups (gid);

LOCK TABLES <%= @mysqldb %>.groups WRITE;
INSERT INTO <%= @mysqldb %>.groups
 (groupname,gid,members)
VALUES
 ('user',2002,'user');
UNLOCK TABLES;

CREATE TABLE IF NOT EXISTS <%= @mysqldb %>.login_history (
  userid VARCHAR(30) NOT NULL,
  client_ip VARCHAR(15) NOT NULL DEFAULT '',
  server_ip VARCHAR(15) NOT NULL DEFAULT '',
  protocol VARCHAR(30) NOT NULL DEFAULT '',
  login_time DATETIME
);

CREATE TABLE IF NOT EXISTS <%= @mysqldb %>.quotalimits (
  name VARCHAR(30),
  quota_type ENUM('user', 'group', 'class', 'all') NOT NULL DEFAULT 'user',
  per_session ENUM('false', 'true') NOT NULL DEFAULT 'false',
  limit_type ENUM('soft', 'hard') NOT NULL DEFAULT 'hard',
  bytes_in_avail FLOAT NOT NULL DEFAULT 0,
  bytes_out_avail FLOAT NOT NULL DEFAULT 0,
  bytes_xfer_avail FLOAT NOT NULL DEFAULT 0,
  files_in_avail INT UNSIGNED NOT NULL DEFAULT 0,
  files_out_avail INT UNSIGNED NOT NULL DEFAULT 0,
  files_xfer_avail INT UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY ('name')
);

LOCK TABLES <%= @mysqldb %>.quotalimits WRITE;
INSERT INTO <%= @mysqldb %>.quotalimits
 (name,quota_type,per_session,limit_type,bytes_in_avail,bytes_out_avail,bytes_xfer_avail,files_in_avail,files_out_avail,files_xfer_avail)
VALUES
 ('user','user','false','hard',20000000,20000000,0,0,0,0);
UNLOCK TABLES;

CREATE TABLE IF NOT EXISTS <%= @mysqldb %>.quotatallies (
  name VARCHAR(30) NOT NULL DEFAULT '',
  quota_type ENUM("user", "group", "class", "all") NOT NULL DEFAULT 'user',
  bytes_in_used FLOAT NOT NULL DEFAULT 0,
  bytes_out_used FLOAT NOT NULL DEFAULT 0,
  bytes_xfer_used FLOAT NOT NULL DEFAULT 0,
  files_in_used INT UNSIGNED NOT NULL DEFAULT 0,
  files_out_used INT UNSIGNED NOT NULL DEFAULT 0,
  files_xfer_used INT UNSIGNED NOT NULL DEFAULT 0
);

LOCK TABLES <%= @mysqldb %>.quotatallies WRITE;
INSERT INTO <%= @mysqldb %>.quotatallies
 (name,quota_type,bytes_in_used,bytes_out_used,bytes_xfer_used,files_in_used,files_out_used,files_xfer_used)
VALUES
 ('user','user',0,0,0,0,0,0);
UNLOCK TABLES;

<% end %>

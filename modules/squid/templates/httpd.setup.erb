#!/bin/bash

initvar(){
  # adss system infomation
  adssbasepath=<%= scope.lookupvar('baseconf::globalparams::basepath') %>

  # install system infomation
  prog="httpd"
  prefix="<%= scope.lookupvar('apache::params::prefix_dir') %>"
  confdir="<%= scope.lookupvar('apache::params::conf_dir') %>"
  datadir="<%= scope.lookupvar('apache::params::data_dir') %>"
  tempdir="<%= scope.lookupvar('apache::params::temp_dir') %>"
  compile_pkg="<%= scope.lookupvar('apache::params::compile_pkg') %>"

  compile_opt="<%= scope.lookupvar('apache::params::compile_opt') %>"

  nowversion="$(${prefix}/bin/httpd -v 2>&1 | head -n1)"
  orderversion="<%= scope.lookupvar('apache::params::version') %>"
}

# main process
install(){
  tar xvf ${adssbasepath}/${prog}/${compile_pkg} -C ${adssbasepath}/${prog}
  cd ${adssbasepath}/${prog}/${compile_pkg%.*.*}
  ./configure --prefix=${prefix} ${compile_opt}
  make -j <%= @processorcount %> && make install
  rm -rf ${adssbasepath}/${prog}/${compile_pkg%.*.*}

  mkdir -pv ${confdir}/conf.d

  mkdir -pv ${datadir}
  chmod 755 ${datadir}
}

uninstall(){
  service ${prog} stop
  [ -d ${prefix} ] && rm -rf ${prefix}
}

initvar
if [ "${nowversion}" != "${orderversion}" ]; then
  uninstall
  install
fi


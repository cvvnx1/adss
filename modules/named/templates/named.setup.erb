#!/bin/bash

initvar(){
  # adss system infomation
  adssbasepath=<%= scope['baseconf::globalparams::basepath'] %>

  # install system infomation
  prog="<%= scope['named::params::prog'] %>"
  version="<%= scope['named::params::version'] %>"
  prefix="<%= scope['named::params::prefix_dir'] %>"
  confdir="<%= scope['named::params::conf_dir'] %>"
  tempdir="<%= scope['named::params::temp_dir'] %>"
  compile_pkg="<%= scope['named::params::compile_pkg'] %>"

  compile_prefix="<%= scope['named::params::compile_prefix'] %>"
  compile_opt="<%= scope['named::params::compile_opt'] %>"
}

# main process
install(){
  tar xvf ${adssbasepath}/${prog}/${compile_pkg} -C ${adssbasepath}/${prog}
  cd ${adssbasepath}/${prog}/${compile_pkg%.*.*}
  eval ${compile_prefix} ./configure --prefix=${prefix} --sysconfdir=${confdir} ${compile_opt}
  make -j <%= @processorcount %> && make install
  echo "${version}" > ${prefix}/version.marker
  rm -rf ${adssbasepath}/${prog}/${compile_pkg%.*.*}

  mkdir -pv ${confdir}/conf.d

}

uninstall(){
  service ${prog} stop
  [ -d ${prefix} ] && rm -rf ${prefix}
}

initvar
if [ "$(cat ${prefix}/version.marker)" != "${version}" ]; then
  uninstall
  install
fi


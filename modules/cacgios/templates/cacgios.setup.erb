#!/bin/bash

initvar(){
  # adss system infomation
  adssbasepath=<%= scope.lookupvar('baseconf::globalparams::basepath') %>

  # main infomation
  prog="cacgios"
  wwwroot="<%= scope.lookupvar('cacgios::params::httpd_documentroot') %>"

  # cacti infomation
  cacti_pkg="<%= scope.lookupvar('cacgios::params::cacti_pkg') %>"
  cacti_dbname="<%= scope.lookupvar('cacgios::params::cacti_dbname') %>"
  cacti_dbuser="<%= scope.lookupvar('cacgios::params::cacti_dbuser') %>"
  cacti_dbpassword="<%= scope.lookupvar('cacgios::params::cacti_dbpassword') %>"

  # cacti plugins infomation
  cacti_plugins_pkg="<%= scope.lookupvar('cacgios::params::cacti_plugins_pkg') %>"

  # cacti npc infomation
  nagios_npc_pkg="<%= scope.lookupvar('cacgios::params::nagios_npc_pkg') %>"

  # nagios infomation
  nagios_pkg="<%= scope.lookupvar('cacgios::params::nagios_pkg') %>"
  nagios_prefix="<%= scope.lookupvar('cacgios::params::nagios_prefix_dir') %>"
  nagios_user="<%= scope.lookupvar('cacgios::params::nagios_user') %>"
  nagios_password="<%= scope.lookupvar('cacgios::params::nagios_password') %>"

  # nagios plugins infomation
  nagios_plugins_pkg="<%= scope.lookupvar('cacgios::params::nagios_plugins_pkg') %>"

  # nagios ndoutils infomation
  nagios_ndoutils_pkg="<%= scope.lookupvar('cacgios::params::nagios_ndoutils_pkg') %>"
}

install_cacti(){
  tar xvf ${adssbasepath}/${prog}/${cacti_pkg} -C ${adssbasepath}/${prog}
  mv ${adssbasepath}/${prog}/${cacti_pkg%.*.*} ${wwwroot}/cacti
  mysql -uroot < ${adssbasepath}/${prog}/cacti_init.sql
  mysql -u${cacti_dbuser} -p${cacti_dbpassword} ${cacti_dbname} < ${wwwroot}/cacti/cacti.sql
}

install_cacti_plugins(){
  tar xvf ${adssbasepath}/${prog}/${cacti_plugins_pkg} -C ${adssbasepath}/${prog}
  cd ${adssbasepath}/${prog}/cacti-plugin-arch
  cp -R * ${wwwroot}/cacti
  mysql -u${cacti_dbuser} -p${cacti_dbpassword} ${cacti_dbname} < ${wwwroot}/cacti/pa.sql
  cd ${wwwroot}/cacti
  patch -p1 -N < cacti-plugin-0.8.7h-PA-v3.0.diff
  rm -rf ${adssbasepath}/${prog}/cacti-plugin-arch
}

install_cacti_npc(){
  tar xvf ${adssbasepath}/${prog}/${nagios_npc_pkg}  -C ${adssbasepath}/${prog}
  mv xvf ${adssbasepath}/${prog}/npc ${wwwroot}/cacti/plugins/
  mysql -u${cacti_dbuser} -p${cacti_dbpassword} ${cacti_dbname} < ${adssbasepath}/${prog}/npc.sql
}

uninstall_cacti(){
  rm -rf ${wwwroot}/cacti
}

install_nagios(){
  tar xvf ${adssbasepath}/${prog}/${nagios_pkg} -C ${adssbasepath}/${prog}
  cd ${adssbasepath}/${prog}/nagios
  ./configure --prefix=${nagios_prefix} --with-command-user=nagios --with-command-group=nagios --with-httpd-conf=/etc/httpd/conf.d
  make -j <%= @processorcount %> all
  make install install-init install-config install-commandmode make install-webconf
  htpasswd -bc ${nagios_prefix}/etc/htpasswd.users ${nagios_user} ${nagios_password}
  rm -rf ${adssbasepath}/${prog}/nagios
}

install_nagios_plugins(){
  tar xvf ${adssbasepath}/${prog}/${nagios_plugins_pkg} -C ${adssbasepath}/${prog}
  cd ${adssbasepath}/${prog}/${nagios_plugins_pkg%.*.*}
  ./configure --prefix=${nagios_prefix} --with-nagios-user=nagios --with-nagios-group=nagios
  make -j <%= @processorcount %>
  make install
  rm -rf ${adssbasepath}/${prog}/${nagios_plugins_pkg%.*.*}
}

install_nagios_ndoutils(){
  tar xvf ${adssbasepath}/${prog}/${nagios_ndoutils_pkg} -C ${adssbasepath}/${prog}
  cd ${adssbasepath}/${prog}/${nagios_ndoutils_pkg%.*.*}
  ./configure --prefix=${nagios_prefix} --enable-mysql --disable-pgsql --with-mysql-inc=/usr/include/mysql --with-mysql-lib=/usr/lib64/mysql
  make -j <%= @processorcount %>
  cp -v src/{ndomod-3x.o,ndo2db-3x,file2sock,log2ndo} ${nagios_prefix}/bin
  cd db
  ./installdb -u${cacti_dbuser} -p${cacti_dbpassword} -hlocalhost -d ${cacti_dbname}
  cd ..
  cp -v config/ndo2db.cfg-sample ${nagios_prefix}/etc/ndo2db.cfg
  cp -v config/ndomod.cfg-sample ${nagios_prefix}/etc/ndomod.cfg
  chmod 644 ${nagios_prefix}/etc/ndo*
  chown nagios.nagios ${nagios_prefix}/etc/*
  chown nagios.nagios ${nagios_prefix}/bin/*
  echo "broker_module=${nagios_prefix}/bin/ndomod-3x.o config_file=${nagios_prefix}/etc/ndomod.cfg" >> ${nagios_prefix}/etc/nagios.cfg
  rm -rf ${adssbasepath}/${prog}/${nagios_ndoutils_pkg%.*.*}
}

uninstall_nagios(){
  rm -rf ${nagios_prefix}
}

initvar
if [ ! -d "${wwwroot}/cacti" ]; then
  uninstall_cacti
  uninstall_nagios
  install_cacti
  install_cacti_plugins
  install_cacti_npc
  install_nagios
  install_nagios_plugins
  install_nagios_ndoutils
fi


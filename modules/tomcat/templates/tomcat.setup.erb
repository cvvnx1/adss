#!/bin/bash

initvar(){
  # adss system infomation
  adssbasepath=<%= scope.lookupvar('baseconf::globalparams::basepath') %>

  # install system infomation
  java_pkg="<%= scope['tomcat::params::java_pkg'] %>"
  java_pkg_dir="<%= scope['tomcat::params::java_pkg_dir'] %>"
  jave_home="<%= scope['tomcat::params::jave_home'] %>"

  prog="tomcat"
  pkg="<%= scope['tomcat::params::pkg'] %>"
  prefix="<%= scope['tomcat::params::prefix_dir'] %>"
  confdir="<%= scope['tomcat::params::conf_dir'] %>"

  mysql_conn_pkg="<%= scope['tomcat::params::mysql_conn_pkg'] %>"
}

# main process
install_java(){
  chmod 755 ${adssbasepath}/${prog}/${java_pkg}
  ${adssbasepath}/${prog}/${java_pkg}
  mv ${adssbasepath}/${prog}/${java_pkg_dir} ${jave_home}

  if [ ! "$(grep "java_path" <%= scope['baseconf::globalparams::envprofile'] %>)" ]; then
    cat >> <%= scope['baseconf::globalparams::envprofile'] %> << EOF
# java_path
JAVA_HOME=${jave_home}
PATH=\$PATH:\$JAVA_HOME/bin
EOF
  fi
  source <%= scope['baseconf::globalparams::envprofile'] %>
}

install_tomcat(){
  tar xvf ${adssbasepath}/${prog}/${pkg} -C ${adssbasepath}/${prog}
  mv ${adssbasepath}/${prog}/${pkg%.*.*} ${prefix}
  cp ${mysql_conn_pkg} ${prefix}/lib/
}

uninstall_java(){
  [ -d ${jave_home} ] && rm -rf ${jave_home}
}

uninstall_tomcat(){
  service ${prog} stop
  [ -d ${prefix} ] && rm -rf ${prefix}
}

initvar
if [ ! -d ${jave_home} ]; then
  uninstall_java
  install_java
fi

if [ ! -d ${prefix} ]; then
  uninstall_tomcat
  install_tomcat
fi
